<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-info { color: #0066cc; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-message { color: #6c757d; }
    </style>
</head>
<body>
    <h1>WebSocket Client Test</h1>

    <div class="section">
        <h2>Connection</h2>
        <div id="status" class="status disconnected">Disconnected</div>

        <div>
            <label>Server URL:</label>
            <input type="text" id="serverUrl" value="ws://localhost:8080" style="width: 300px;">
        </div>
        <div>
            <label>Conversation ID:</label>
            <input type="text" id="conversationId" value="" style="width: 250px;">
            <button onclick="generateUUID()">Generate UUID</button>
        </div>
        <div>
            <button id="connectBtn" onclick="toggleConnection()">Connect</button>
            <button onclick="ping()" id="pingBtn" disabled>Send Ping</button>
        </div>
    </div>

    <div class="section">
        <h2>Send Message</h2>
        <textarea id="message" rows="4" cols="60" placeholder="Enter your message to Claude..."></textarea><br>
        <button onclick="sendMessage()" id="sendBtn" disabled>Send Message</button>
    </div>

    <div class="section">
        <h2>Log</h2>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        let ws = null;
        let isConnected = false;

        // Generate UUID
        function generateUUID() {
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            document.getElementById('conversationId').value = uuid;
        }

        // Initialize with UUID
        generateUUID();

        // Log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Update status display
        function updateStatus(status) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const pingBtn = document.getElementById('pingBtn');
            const sendBtn = document.getElementById('sendBtn');

            statusDiv.className = `status ${status}`;

            if (status === 'connected') {
                statusDiv.textContent = 'âœ… Connected';
                connectBtn.textContent = 'Disconnect';
                pingBtn.disabled = false;
                sendBtn.disabled = false;
                isConnected = true;
            } else if (status === 'connecting') {
                statusDiv.textContent = 'â³ Connecting...';
                connectBtn.disabled = true;
                pingBtn.disabled = true;
                sendBtn.disabled = true;
                isConnected = false;
            } else {
                statusDiv.textContent = 'âŒ Disconnected';
                connectBtn.textContent = 'Connect';
                pingBtn.disabled = true;
                sendBtn.disabled = true;
                isConnected = false;
            }
        }

        // Toggle connection
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        // Connect to server
        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const conversationId = document.getElementById('conversationId').value;

            if (!conversationId) {
                log('Error: Conversation ID is required', 'error');
                return;
            }

            updateStatus('connecting');
            log(`Connecting to ${serverUrl}?conversationId=${conversationId}...`, 'info');

            const url = new URL(serverUrl);
            url.searchParams.set('conversationId', conversationId);

            ws = new WebSocket(url.toString());

            ws.onopen = () => {
                log('WebSocket connected', 'success');
                updateStatus('connected');
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    log(`Received: ${message.type}`, 'message');
                    console.log('Message:', message);

                    switch (message.type) {
                        case 'connected':
                            log(`âœ… ${message.message}`, 'success');
                            log(`Conversation ID: ${message.conversationId}`, 'info');
                            break;
                        case 'reconnected':
                            log(`ðŸ”„ ${message.message}`, 'success');
                            break;
                        case 'ai_stream':
                            log(`ðŸ¤– Claude: ${message.content}`, 'message');
                            break;
                        case 'ai_done':
                            log('âœ… Claude finished', 'success');
                            break;
                        case 'request':
                            log(`ðŸ”§ Server request: ${message.action}`, 'info');
                            log(`   Request ID: ${message.requestId}`, 'info');
                            log(`   Params: ${JSON.stringify(message.params)}`, 'info');
                            break;
                        case 'error':
                            log(`âŒ Error: ${message.message}`, 'error');
                            break;
                        case 'ai_error':
                            log(`âŒ Claude Error: ${message.error}`, 'error');
                            break;
                        case 'pong':
                            log('ðŸ“ Pong received', 'info');
                            break;
                        default:
                            log(`â“ Unknown message type: ${message.type}`, 'info');
                    }
                } catch (error) {
                    log(`Failed to parse message: ${error}`, 'error');
                }
            };

            ws.onerror = (error) => {
                log('WebSocket error', 'error');
                console.error('WebSocket error:', error);
            };

            ws.onclose = (event) => {
                log(`Connection closed: ${event.code} - ${event.reason}`, 'info');
                updateStatus('disconnected');
            };
        }

        // Disconnect
        function disconnect() {
            if (ws) {
                log('Disconnecting...', 'info');
                ws.close(1000, 'User disconnect');
                ws = null;
            }
        }

        // Send message
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected', 'error');
                return;
            }

            const content = document.getElementById('message').value;
            const conversationId = document.getElementById('conversationId').value;

            if (!content.trim()) {
                log('Error: Message is empty', 'error');
                return;
            }

            const message = {
                type: 'user_message',
                conversationId: conversationId,
                content: content,
                context: {
                    currentFile: 'test.md',
                    selection: 'Selected text',
                    frontmatter: { title: 'Test Note' },
                    tags: ['test', 'websocket']
                }
            };

            ws.send(JSON.stringify(message));
            log(`Sent: user_message (${content.length} chars)`, 'success');

            // Clear message
            document.getElementById('message').value = '';
        }

        // Send ping
        function ping() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Error: Not connected', 'error');
                return;
            }

            ws.send(JSON.stringify({ type: 'ping' }));
            log('Sent: ping', 'success');
        }

        // Auto-generate UUID on page load
        window.onload = () => {
            log('Test page loaded', 'info');
            log('Click "Connect" to test WebSocket connection', 'info');
        };
    </script>
</body>
</html>
